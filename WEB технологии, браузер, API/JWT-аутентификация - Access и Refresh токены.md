## Основная концепция

**[[JSON Web Token|JWT]] (JSON Web Token)** — это стандарт для создания токенов доступа, которые используются для безопасной передачи информации между сторонами. В контексте аутентификации, JWT содержит зашифрованную информацию о пользователе.

После успешного входа пользователя в систему сервер генерирует два токена: `accessToken` и `refreshToken`.

---

## Access Token (Токен доступа)

`accessToken` — это основной токен, который клиент использует для аутентификации каждого запроса к защищённым ресурсам сервера.

- **Короткое время жизни:** Обычно `accessToken` живёт недолго, например, **15-30 минут**. Это делается для безопасности: если токен будет перехвачен, злоумышленник сможет использовать его лишь в течение короткого промежутка времени.
    
- **Хранение:** `accessToken` обычно хранится на клиенте в оперативной памяти (например, в переменной в JavaScript) или в `localStorage`/`sessionStorage`. Его **не рекомендуется** хранить в `cookie`, доступных из JavaScript, из-за уязвимости к [[XSS-атаки|XSS-атакам]].
    
- **Использование:** При каждом запросе к API клиент прикрепляет `accessToken` в заголовок `Authorization` (обычно в формате `Bearer <token>`).
    

---

## Refresh Token (Токен обновления)

`refreshToken` — это специальный токен с длительным сроком жизни, который используется **исключительно для получения нового `accessToken`**.

- **Длительное время жизни:** `refreshToken` может жить от нескольких дней до нескольких месяцев (например, **7-30 дней**).
    
- **Безопасное хранение:** Для защиты от [[XSS-атаки|XSS-атак]] `refreshToken` хранится в **`HttpOnly` cookie**. Такие cookie автоматически отправляются браузером на сервер при каждом запросе, но к ним невозможно получить доступ из JavaScript. Это самый безопасный способ хранения на клиенте.
    

---

## Схема работы

1. **Логин:** Пользователь отправляет логин и пароль на сервер.
    
2. **Получение токенов:** В случае успеха сервер возвращает:
    
    - `accessToken` в теле ответа.
        
    - `refreshToken` в `HttpOnly` cookie через заголовок `Set-Cookie`.
        
3. **Запросы к API:** Клиент отправляет запросы к защищённым ресурсам, прикрепляя `accessToken` в заголовок `Authorization`.
    
4. **Истечение `accessToken`:** Когда `accessToken` устаревает, сервер отвечает ошибкой `401 Unauthorized`.
    
5. **Обновление токена:**
    
    - Получив ошибку `401`, клиент автоматически (без участия пользователя) отправляет запрос на специальный эндпоинт (например, `/refresh`) для обновления токена. Браузер автоматически прикрепит `refreshToken` из `HttpOnly` cookie к этому запросу.
        
    - Сервер проверяет `refreshToken`.
        
6. **Результат обновления:**
    
    - **Если `refreshToken` валиден**, сервер генерирует и отправляет новый `accessToken`. Клиент сохраняет его и повторяет изначальный запрос, который не удался.
        
    - **Если `refreshToken` невалиден** (например, истёк срок его действия или он был скомпрометирован), сервер возвращает ошибку `401`. В этом случае пользователю необходимо будет заново пройти процедуру логина.